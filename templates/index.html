{% extends '_layout.html' %}

{% block title %}
Stock whisperers
{% endblock %}
{% block body %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/lightweight-charts@3.4.0/dist/lightweight-charts.standalone.production.js"></script>
<style>
    .container{
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 5px;
    }
    .container .coin-price{
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px 20px;
        border-radius: 5px;
        box-shadow: 0 0 3px #ccc;
        margin: 7px;
    }
    
    .container .coin-price .logo{
        width: 70px;
        margin-right: 10px;
    }
    .container .coin-price .logo img{
        width: 100%;
    }
    .container .coin-price div{
        display: block;
    }
    .container .coin-price div h1{
        font-size: 20px;
    }
</style>
    <div id="chart-container" style="width: 100%; height: 400px;"></div>

    <div class="container">
        <div class="coin-price">
            <div class="logo"><img src="https://blogger.googleusercontent.com/img/a/AVvXsEi32rDKQR2Swi7YfHjDzyZUBGEmxTz77OClnm24SZl7kWuls7fsVCIfAObY_JRJIReQnBWZIPSVfDLSqDvqeu4CCXCoNQIoUGK-OSDUGMtDJFxh9vmU6WGajIgXH4CsR_-sXU0qWbyJTJl7N0BSTB8HcAGSpCJ54G1daZPnU6h2oANo2CTGsbHCoaGJHQ" ></div>
            <div>
                <h1>$<span id="bitcoin"></span></h1>
                <h1>Bitcoin</h1>
            </div>
        </div>
        <div class="coin-price">
            <div class="logo"><img src="https://blogger.googleusercontent.com/img/a/AVvXsEhrUFoHC68rLHQYMV41awqGtoeU6qI-CkSVmcYK-KBCrOvL-jzwLOx8pN-5B8aALsHh1Zc9mmDm8LVQSSpdpsw0v6vrJsv4r9_lv0ic5aYbogc3i3h9mG6ZGMc7g9_cGSRh_soaKmXtpMEOxBFIsmiTa_wticu9T07MbqQ42J9NwowHp8tn8OUIBlhjqA" ></div>
            <div>
                <h1>$<span id="litecoin"></span></h1>
                <h1>Litecoin</h1>
            </div>
        </div>
       
        <div class="coin-price">
            <div class="logo"><img src="https://blogger.googleusercontent.com/img/a/AVvXsEgfcodOJm7ZIXw2kiqdo5abN4cUvFYgyqpKt91zHI8710ltPK5Ny_S5X93w9LSDsF5jW61frn3C8a_8w2GXu4bf0clzxuJljoQ8n6az5EI5zQOcl5W2LScP-1-41NQwPW5A3JWT9EwejtOnHsd3q2-llUsJJQ3Z74v_2FOPn0TrI2529NS9_hmFbvModw" ></div>
            <div>
                <h1>$<span id="ethereum"></span></h1>
                <h1>Ethereum</h1>
            </div>
        </div>
        <div class="coin-price">
            <div class="logo"><img src="https://blogger.googleusercontent.com/img/a/AVvXsEj9YzGIFUSMpRoWE4IjGl_o2zpdPkvtUS6jzIgZWEWl7ztYyV20oXu80A52v0R_nXpt_qXVBzxnfse2_pfeIbVHwQSR3oLqqAyMqVqnzJpdbSCBHA2b_zlheiLY3Bb0PYCEXQny7q-FnGE01ZtxVFVC8DbLWW-ZC1PC-gaqL7IC7ZfRxFOZufcv8lcY1g" ></div>
            <div>
                <h1>$<span id="dogecoin"></span></h1>
                <h1>Dogecoin</h1>
            </div>
        </div>

    </div>
    </div>

    <div class = "comments-section"> 
        <h3> Live Comments</h3> 
        <div id = "comments-container"> 

        </div> 
      <!-- if user is logged in --> 
      
        <div class = "comment-form"> 
            <textarea id="comment-input" placeholder="Enter comment"></textarea>
            <button onclick="submitComment()"> Submit Comment </button>
        </div> 
        
    </div>
    <script>
        
        var chart = LightweightCharts.createChart(document.getElementById('chart-container'), {
            width: document.getElementById('chart-container').clientWidth,
            height: 400
        });

        var candleSeries = chart.addCandlestickSeries();

        chart.applyOptions({
            timeScale: {
                timeVisible:true,
                secondsVisible:true
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            }
    //<!-- --- - -  Live Comment Code- - - - - - --  - - - - -- - - - - - -- - - - - - - -- - - - -  -   -->


    //append new comments 
        });

        var btc = document.getElementById("bitcoin");
        var ltc = document.getElementById("litecoin");
        var eth = document.getElementById("ethereum");
        var doge = document.getElementById("dogecoin");

        var liveprice = {
            "async": true,
            "scroosDomain": true,
            "url": "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin%2Clitecoin%2Cethereum%2Cdogecoin&vs_currencies=usd",

            "method": "GET",
            "headers": {}
        }

        $.ajax(liveprice).done(function (response){
            console.log(response)
            btc.innerHTML = response.bitcoin.usd;
            ltc.innerHTML = response.litecoin.usd;
            eth.innerHTML = response.ethereum.usd;
            doge.innerHTML = response.dogecoin.usd;

        });
        fetch('/data')
            .then(response => response.json())
            .then(data => {
                
                const formattedData = data.map(item => ({
                    time: ((new Date(item.date).getTime() / 1000) - (5 * 60 * 60)), // Convert UTC to EST (Standard Time)
                    open: item.open,
                    high: item.high,
                    low: item.low,
                    close: item.close,
                    volume: item.volume
                }));

                candleSeries.setData(formattedData);
                //console.log((new Date(item.date).getTime() / 1000))
            })
            .catch(error => console.error('Error fetching data:', error));
        
            
            
        var socket = io.connect();
        socket.on('updateSensorData', (new_value)=>{
            data = JSON.parse(new_value['value']);

            const updatedData = {
                time: ((new Date(data.date['0']).getTime() / 1000) - (5 * 60 * 60)),
                open: data.open['0'],
                high: data.high['0'],
                low: data.low['0'],
                close: data.close['0']
            };
            console.log(updatedData);
            candleSeries.update(updatedData);

            
        });
        socket.on('new_comment', function(commentData) {   
    
            let commentElement = document.createElement("div"); 
            commentElement.innerHTML = `<strong>User ${commentData.user_id}:</strong> ${commentData.content}`; 
            document.getElementById("comments-container").appendChild(commentElement); 
        });
    
        function submitComment() { 
            let commentContent =document.getElementById("comment-input").value; 
            socket.emit('send_comment', { comment: commentContent}); 
            document.getElementById("comment-input").value = ' '; 
        } 
    
        fetch('/comment')
        .then(response => response.json())
        .then(comments => { 
            comments.forEach(comment => { 
                let commentElement = document.createElement("div") 
                commentElement.innerHTML = `<strong>User ${comment.user_id}:</strong> ${comment.content}`;
                document.getElementById("comments-container").appendChild(commentElement); 
            }); 
        }); 

        /* const binanceSocket = new WebSocket('wss://stream.binance.com:9443/ws/bnbusdt@kline_1m');

        binanceSocket.onopen = function (event) {
            console.log("WebSocket opened");
        };
        
        binanceSocket.onmessage = function (event) {
            var message = JSON.parse(event.data);

            var candlestick = message.k;

            candleSeries.update({
                time: ((new Date(candlestick.t).getTime() / 1000) - (5 * 60 * 60)), // Convert UTC to EST (Standard Time)
                open: candlestick.o,
                high: candlestick.h,
                low: candlestick.l,
                close: candlestick.c,
                volume: candlestick.volume
            })

    <script>  
      var socket = io.connect('http://' + document.domain + ':' + location.port); 

    // using QuerySelectors to get value of comment. 
    function getVal() { 
        const commentContent = document.querySelector('#comment-input').value; 
        return commentContent;  
    } 

    // submit comment function 
    function submitComment() { 
        let commentContent = getVal(); 
        console.log(commentContent); 
       
        // emitting comments with socketio 
        socket.emit('send_comment', { comment: commentContent}); 
    // }  
        document.querySelector("#comment-input").value = ' '; // clear text box after hitting submit. 
    } 


    // append new comments  
    socket.on('new_comment', function(commentData) {    
        let commentsContainer = document.querySelector("#comments-container"); 
        let commentElement = document.createElement("div"); 
        commentElement.innerHTML = `<strong>User ${commentData.user_id}:</strong> ${commentData.content}`;
        commentsContainer.appendChild(commentElement); 
    });

   
    fetch('/comment')
    .then(response => response.json())
    .then(comments => {
        let commentsContainer = document.querySelector("#comments-container"); 
        comments.forEach(comment => { 
            let commentElement = document.createElement("div");
            commentElement.innerHTML = `<strong>User ${comment.user_id}:</strong> ${comment.content}`; 
            commentsContainer.appendChild(commentElement); 

        });  

     }); 


        };
        
        binanceSocket.onclose = function (event) {
            console.log("WebSocket closed:", event);
        };
        
        binanceSocket.onerror = function (error) {
            console.error("WebSocket error:", error);
        }; 


         */
    </script>

    <!-- <div class = "comments-section"> 
        <h3> Live Comments</h3> 
        <div id = "comments-container"> 

        </div>  -->
    {% if user %}
    <div class="comment-form"> 
    <textarea id="comment-input" placeholder="Enter comment"></textarea>
    <button onclick="submitComment()"> Comment </button>
    </div> 
    {% endif %}
    </div> 

{% endblock %}
