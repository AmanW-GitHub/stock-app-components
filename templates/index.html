{% extends '_layout.html' %}

{% block title %}
Stock whisperers
{% endblock %}
{% block body %}
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
    
    <div class="hero-section">
    <div class="graph-title">
        <form>
            
        </form>
        <h2>
            Stock Prices
        </h2>
    </div>
    <div id="bargraph"></div>
    </div>

    <div class = "comments-section"> 
        <h3> Live Comments</h3> 
        <div id = "comments-container"> 

        </div> 
      <!-- if user is logged in --> 
      
        <div class = "comment-form"> 
            <textarea id="comment-input" placeholder="Enter comment"></textarea>
            <button onclick="submitComment()"> Submit Comment </button>
        </div> 
        
    </div>
    <script>        
        var socket = io.connect('http://' + document.domain + ':' + location.port);

        socket.on('connect', function () {
            console.log('Connected');
        });
        //var myPlot = document.getElementById('myDiv');

        socket.on('updateGraph', function (msg) {

            var graphData = JSON.parse(msg.value);

            graphData.layout.xaxis.autorange = true;

            Plotly.react('bargraph', graphData.data, graphData.layout); // Update the existing graph

            //Plotly.on()
        });



        socket.on('disconnect', function () {
            console.log('Disconnected');
        });
    </script>
    <style>
        #bargraph {
            height: 50vh;
            width: 50%;
            margin: auto;
            padding: 10px;
          }
          .modebar {
            display: none !important;
            }
    </style>  

    <!----- - -  Live Comment Code- - - - - - --  - - - - -- - - - - - -- - - - - - - -- - - - -  - -->  

    <script>  
      var socket = io.connect('http://' + document.domain + ':' + location.port); 

    // using QuerySelectors to get value of comment. 
    function getVal() { 
        const commentContent = document.querySelector('#comment-input').value; 
        return commentContent;  
    } 

    // submit comment function 
    function submitComment() { 
        let commentContent = getVal(); 
        console.log(commentContent); 
       
        // emitting comments with socketio 
        socket.emit('send_comment', { comment: commentContent}); 
        // document.getElementById("comment-input").value = ' '; 
    // }  
        document.querySelector("#comment-input").value = ' '; // clear text box after hitting submit. 
    } 


    // append new comments  
    socket.on('new_comment', function(commentData) {    
        let commentsContainer = document.querySelector("#comments-container"); 
        let commentElement = document.createElement("div"); 
        commentElement.innerHTML = `<strong>User ${commentData.user_id}:</strong> ${commentData.content}`;
        commentsContainer.appendChild(commentElement); 
    });

   
    fetch('/comment')
    .then(response => response.json())
    .then(comments => {
        let commentsContainer = document.querySelector("#comments-container"); 
        comments.forEach(comment => { 
            let commentElement = document.createElement("div");
            commentElement.innerHTML = `<strong>User ${comment.user_id}:</strong> ${comment.content}`; 
            commentsContainer.appendChild(commentElement); 

        });  

     }); 

    </script> 

    <div class = "comments-section"> 
        <h3> Live Comments</h3> 
        <div id = "comments-container"> 

        </div> 
    {% if user %}
    <div class="comment-form"> 
    <textarea id="comment-input" placeholder="Enter comment"></textarea>
    <button onclick="submitComment()"> Comment </button>
    </div> 
    {% endif %}
    </div> 

{% endblock %}
