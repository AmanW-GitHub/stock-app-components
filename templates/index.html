{% extends '_layout.html' %}

{% block title %}
Stock whisperers
{% endblock %}
{% block body %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/lightweight-charts@3.4.0/dist/lightweight-charts.standalone.production.js"></script>
<style>
    .container{
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 5px;
    }
    .container .coin-price{
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px 20px;
        border-radius: 5px;
        box-shadow: 0 0 3px #ccc;
        margin: 7px;
    }
    
    .container .coin-price .logo{
        width: 70px;
        margin-right: 10px;
    }
    .container .coin-price .logo img{
        width: 100%;
    }
    .container .coin-price div{
        display: block;
    }
    .container .coin-price div h1{
        font-size: 20px;
    }
    .container {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
    }

    /* New styles for hero section */
    .hero-section {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 50px;

    }

    .hero-section .row {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
        margin-bottom: 50px;
        flex-direction: column;
    }

    .hero-section .col {
        /* flex: 0 0 calc(50% - 10px); */
        margin-bottom: 20px;
    }


    .hero-section #chart-container {
        width: 100%;
        height: 400px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-top: 15vh;
    }

    .comments-section {
        margin-top: 50px;
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 5px;
        max-height: 500px;
        overflow: scroll;
    }

    .comments-section h3 {
        margin-top: 0;
        font-size: 22px;
    }

    .comments-section #comments-container {
        margin-top: 50px;
        border-top: 1px solid #ddd;
        padding-top: 10px;
    }

    .comments-section .comment-form {
        margin-top: 50px;
    }

    .comments-section .comment-form textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        resize: vertical;
    }

    .comments-section .comment-form button {
        padding: 10px 20px;
        border-radius: 5px;
        background-color: #007bff;
        color: #fff;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .comments-section .comment-form button:hover {
        background-color: #0056b3;
    }

      .wrapper{
        margin: auto auto;
        margin-left: 33%;
        padding: 25px;
        position: absolute;
        width: 325px;
        
     }
     
     .wrapper .search-input{
        background: #fff;
        width: 100%;
        border-radius: 5px;
        position: relative;
        box-shadow: 0px 1px 5px 3px rgba(0,0,0,0.12);
        z-index: 3; 
     }

      .search-input input{
        height: 55px;
        width: 100%;
        outline: none;
        border: none;
        border-radius: 5px;
        padding: 0 60px 0 20px;
        font-size: 18px;
        box-shadow: 0px 1px 5px rgba(0,0,0,0.1);
        
      }
      .search-input.active input{
        border-radius: 5px 5px 0 0;
        
      }
      .search-input .autocom-box{
        padding: 0;
        opacity: 0;
        pointer-events: none;
        max-height: 280px;
        overflow-y: auto;

      }
      .search-input.active .autocom-box{
        padding: 10px 8px;
        opacity: 1;
        pointer-events: auto;
        
      }
      .autocom-box li{
        list-style: none;
        padding: 8px 12px;
        display: none;
        width: 100%;
        cursor: default;
        border-radius: 3px;
      }
      
      .search-input.active .autocom-box li{
        display: block;
      }
      .autocom-box li:hover{
        background: #efefef;
        
      }

      #tickers-grid {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        gap: 20px;
        padding: 10px;
      }
      
      /* Individual stock box styles */
      .stock-box {
        width: 200px;
        padding: 10px;
        border: 2px solid #ccc;
        border-radius: 8px;
        text-align: center;
        transition: background-color 0.3s ease;
      }
      
      /* Different color classes for stock prices and percentages */
      .dark-red {
        color: darkred;
      }
      
      .red {
        color: red;
      }
      
      .gray {
        color: gray;
      }
      
      .green {
        color: green;
      }
      
      .dark-green {
        color: darkgreen;
      }
      
      /* Flashing effect classes */
      .red-flask {
        background-color: rgba(255, 0, 0, 0.5);
      }
      
      .green-flask {
        background-color: rgba(0, 255, 0, 0.5);
      }
      
      .gray-flask {
        background-color: rgba(169, 169, 169, 0.5);
      }
</style>

<div class="hero-section">
    
    <div class="row">
    <div class ='col'>
        <div class="wrapper">
            <div class="search-input">
              <a href="" target="_blank" hidden></a>
              <input type="text" placeholder="Type to search..">
              <div class="autocom-box">
                <!-- here list are inserted from javascript -->
              </div>
              <div class="icon"><i class="fas fa-search"></i></div>
            </div>
          </div>
    <div id="chart-container" style="width: 100%; height: 100%;"></div>
    </div>
    <div class="col">
    <div class = "comments-section"> 
        <h3> Live Comments</h3> 
        <div id = "comments-container"> 

        </div> 
      <!-- if user is logged in --> 
      
        <div class = "comment-form"> 
            <textarea id="comment-input" placeholder="Enter comment"></textarea>
            <button onclick="submitComment()"> Submit Comment </button>
        </div> 
    </div>
    </div>
</div>
</div>
<div class="watchlist-section">
    <div class="container">
        <div class="coin-price">
            <div class="logo"><img src="https://blogger.googleusercontent.com/img/a/AVvXsEi32rDKQR2Swi7YfHjDzyZUBGEmxTz77OClnm24SZl7kWuls7fsVCIfAObY_JRJIReQnBWZIPSVfDLSqDvqeu4CCXCoNQIoUGK-OSDUGMtDJFxh9vmU6WGajIgXH4CsR_-sXU0qWbyJTJl7N0BSTB8HcAGSpCJ54G1daZPnU6h2oANo2CTGsbHCoaGJHQ" ></div>
            <div>
                <h1>$<span id="bitcoin"></span></h1>
                <h1>Bitcoin</h1>
            </div>
        </div>
        <div class="coin-price">
            <div class="logo"><img src="https://blogger.googleusercontent.com/img/a/AVvXsEhrUFoHC68rLHQYMV41awqGtoeU6qI-CkSVmcYK-KBCrOvL-jzwLOx8pN-5B8aALsHh1Zc9mmDm8LVQSSpdpsw0v6vrJsv4r9_lv0ic5aYbogc3i3h9mG6ZGMc7g9_cGSRh_soaKmXtpMEOxBFIsmiTa_wticu9T07MbqQ42J9NwowHp8tn8OUIBlhjqA" ></div>
            <div>
                <h1>$<span id="litecoin"></span></h1>
                <h1>Litecoin</h1>
            </div>
        </div>
       
        <div class="coin-price">
            <div class="logo"><img src="https://blogger.googleusercontent.com/img/a/AVvXsEgfcodOJm7ZIXw2kiqdo5abN4cUvFYgyqpKt91zHI8710ltPK5Ny_S5X93w9LSDsF5jW61frn3C8a_8w2GXu4bf0clzxuJljoQ8n6az5EI5zQOcl5W2LScP-1-41NQwPW5A3JWT9EwejtOnHsd3q2-llUsJJQ3Z74v_2FOPn0TrI2529NS9_hmFbvModw" ></div>
            <div>
                <h1>$<span id="ethereum"></span></h1>
                <h1>Ethereum</h1>
            </div>
        </div>
        <div class="coin-price">
            <div class="logo"><img src="https://blogger.googleusercontent.com/img/a/AVvXsEj9YzGIFUSMpRoWE4IjGl_o2zpdPkvtUS6jzIgZWEWl7ztYyV20oXu80A52v0R_nXpt_qXVBzxnfse2_pfeIbVHwQSR3oLqqAyMqVqnzJpdbSCBHA2b_zlheiLY3Bb0PYCEXQny7q-FnGE01ZtxVFVC8DbLWW-ZC1PC-gaqL7IC7ZfRxFOZufcv8lcY1g" ></div>
            <div>
                <h1>$<span id="dogecoin"></span></h1>
                <h1>Dogecoin</h1>
            </div>
        </div>

    </div>
    <form id="add-ticker-form">
        <input type="text" id="new-ticker" placeholder="Add Ticker" required> 
        <button type="submit">Add</button>
    </form>
    <div id="tickers-grid"></div>
    </div>

    
    <script>
        var tickers = JSON.parse(localStorage.getItem('tickers')) || [];
        var lastPrices = {};
        var counter = 15;
        
        const startUpdateCycle = () => {
            updatePrices();
            setInterval(() => {
                counter --;
                if(counter <= 0){
                    updatePrices();
                    counter = 15;
                }
            }, 1000)
        }

        $(document).ready(() => {

        tickers.forEach((ticker)=>{
            addTickerToGrid(ticker);
        })

        updatePrices();

        $("#add-ticker-form").submit((e)=>{
            e.preventDefault();
            var newTicker = $('#new-ticker').val().toUpperCase();
            if(!tickers.includes(newTicker)){
                tickers.push(newTicker);
                localStorage.setItem('tickers', JSON.stringify(tickers))
                addTickerToGrid(newTicker);
            }
            $('new-ticker').val('');
            updatePrices();
        })

        $('#tickers-grid').on('click', '.remove-btn', function() {
            console.log(1)
            var tickerToRemove = $(this).data('ticker');
            tickers = tickers.filter(t => t !== tickerToRemove);
            localStorage.setItem('tickers', JSON.stringify(tickers))
            $(`#${tickerToRemove}`).remove();
        });
        startUpdateCycle();

        });

        const addTickerToGrid = (ticker) =>{
            $('#tickers-grid').append(`<div id="${ticker}" class="stock-box"><h2>${ticker}</h2>
                <p id="${ticker}-price"></p><p id="${ticker}-pct"></p>
                <button class="remove-btn" data-ticker="${ticker}">Remove</button></div>`)

        }
        const updatePrices = () => {
            tickers.forEach((ticker)=>{
                $.ajax({
                    url: '/watchlist',
                    type: "POST",
                    data: JSON.stringify({
                        'ticker': ticker
                    }),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: (data) => {
                        var changePercent = ((data.currentPrice-data.openPrice)/ data.openPrice) * 100;
                        var colorclass;
                        if(changePercent <= -2){
                            colorclass = 'dark-red';
                        }
                        else if(changePercent < 0){
                            colorclass = 'red';
                        }
                        else if(changePercent == 0){
                            colorclass = 'gray';
                        }
                        else if(changePercent <= 2){
                            colorclass = 'green';
                        }
                        else{
                            colorclass = 'dark-green';
                        }

                        $(`#${ticker}-price`).text(`$${data.currentPrice.toFixed(2)}`);
                        $(`#${ticker}-pct`).text(`${changePercent.toFixed(2)}%`);

                        $(`#${ticker}-price`).removeClass(`dark-red red gray green dark-green`).addClass(colorclass);
                        $(`#${ticker}-pct`).removeClass(`dark-red red gray green dark-green`).addClass(colorclass);

                        var flaskClass;
                        if(lastPrices[ticker]>data.currentPrice){
                            flaskClass = 'red-flask';
                        }else if(lastPrices[ticker]<data.currentPrice){
                            flaskClass = 'green-flask';
                        }
                        else{
                            flaskClass = 'gray-flask'
                        }
                        lastPrices[ticker] = data.currentPrice;

                        $(`#${ticker}`).addClass(flaskClass);
                        setTimeout(()=>{
                            $(`#${ticker}`).removeClass(flaskClass);
                        }, 1000);
                    }
                });
            });
        }




        var chart = LightweightCharts.createChart(document.getElementById('chart-container'), {
            width: document.getElementById('chart-container').clientWidth,
            height: 550
        });

        var candleSeries = chart.addCandlestickSeries();

        chart.applyOptions({
            timeScale: {
                timeVisible:true,
                secondsVisible:true
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            }
    //<!-- --- - -  Live Comment Code- - - - - - --  - - - - -- - - - - - -- - - - - - - -- - - - -  -   -->


    //append new comments 
        });

        var btc = document.getElementById("bitcoin");
        var ltc = document.getElementById("litecoin");
        var eth = document.getElementById("ethereum");
        var doge = document.getElementById("dogecoin");

        var liveprice = {
            "async": true,
            "scroosDomain": true,
            "url": "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin%2Clitecoin%2Cethereum%2Cdogecoin&vs_currencies=usd",

            "method": "GET",
            "headers": {}
        }

        $.ajax(liveprice).done(function (response){
            console.log(response)
            btc.innerHTML = response.bitcoin.usd;
            ltc.innerHTML = response.litecoin.usd;
            eth.innerHTML = response.ethereum.usd;
            doge.innerHTML = response.dogecoin.usd;

        });
        fetch('/data')
            .then(response => response.json())
            .then(data => {
                
                const formattedData = data.map(item => ({
                    time: ((new Date(item.date).getTime() / 1000) - (5 * 60 * 60)), // Convert UTC to EST (Standard Time)
                    open: item.open,
                    high: item.high,
                    low: item.low,
                    close: item.close,
                    volume: item.volume
                }));

                candleSeries.setData(formattedData);
                //console.log((new Date(item.date).getTime() / 1000))
            })
            .catch(error => console.error('Error fetching data:', error));
        
            
            
        var socket = io.connect();
        socket.on('updateSensorData', (new_value)=>{
            data = JSON.parse(new_value['value']);

            const updatedData = {
                time: ((new Date(data.date['0']).getTime() / 1000) - (5 * 60 * 60)),
                open: data.open['0'],
                high: data.high['0'],
                low: data.low['0'],
                close: data.close['0']
            };
            console.log(updatedData);
            candleSeries.update(updatedData);

            
        });
        socket.on('new_comment', function(commentData) {   
            let commentElement = document.createElement("div"); 
            commentElement.innerHTML = `<strong>${commentData['username']}:</strong> ${commentData['content']}`; 
            document.getElementById("comments-container").appendChild(commentElement); 
        });
    
        function submitComment() { 
            let commentContent =document.getElementById("comment-input").value; 
            socket.emit('send_comment', { comment: commentContent}); 
            document.getElementById("comment-input").value = ' '; 
        } 

        fetch('/comment')
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error(`Error: ${response.status}`);
            }
        })
        .then(comments => {
            comments.forEach(comment => {
                let commentElement = document.createElement("div");
                commentElement.innerHTML = `<strong>${comment.username}:</strong> ${comment.content}`;
                document.getElementById("comments-container").appendChild(commentElement);
            });
        })
        .catch(error => {
            console.error('Error fetching comments:', error);
        });


        /* const binanceSocket = new WebSocket('wss://stream.binance.com:9443/ws/bnbusdt@kline_1m');

        binanceSocket.onopen = function (event) {
            console.log("WebSocket opened");
        };
        
        binanceSocket.onmessage = function (event) {
            var message = JSON.parse(event.data);

            var candlestick = message.k;

            candleSeries.update({
                time: ((new Date(candlestick.t).getTime() / 1000) - (5 * 60 * 60)), // Convert UTC to EST (Standard Time)
                open: candlestick.o,
                high: candlestick.h,
                low: candlestick.l,
                close: candlestick.c,
                volume: candlestick.volume
            })

    <script>  
      var socket = io.connect('http://' + document.domain + ':' + location.port); 

    // using QuerySelectors to get value of comment. 
    function getVal() { 
        const commentContent = document.querySelector('#comment-input').value; 
        return commentContent;  
    } 

    // submit comment function 
    function submitComment() { 
        let commentContent = getVal(); 
        console.log(commentContent); 
       
        // emitting comments with socketio 
        socket.emit('send_comment', { comment: commentContent}); 
    // }  
        document.querySelector("#comment-input").value = ' '; // clear text box after hitting submit. 
    } 


    // append new comments  
    socket.on('new_comment', function(commentData) {    
        let commentsContainer = document.querySelector("#comments-container"); 
        let commentElement = document.createElement("div"); 
        commentElement.innerHTML = `<strong>User ${commentData.user_id}:</strong> ${commentData.content}`;
        commentsContainer.appendChild(commentElement); 
    });

   
    fetch('/comment')
    .then(response => response.json())
    .then(comments => {
        let commentsContainer = document.querySelector("#comments-container"); 
        comments.forEach(comment => { 
            let commentElement = document.createElement("div");
            commentElement.innerHTML = `<strong>User ${comment.user_id}:</strong> ${comment.content}`; 
            commentsContainer.appendChild(commentElement); 

        });  

     }); 


        };
        
        binanceSocket.onclose = function (event) {
            console.log("WebSocket closed:", event);
        };
        
        binanceSocket.onerror = function (error) {
            console.error("WebSocket error:", error);
        }; 


         */

        // getting all required elements
    const searchWrapper = document.querySelector(".search-input");
    const inputBox = searchWrapper.querySelector("input");
    const suggBox = searchWrapper.querySelector(".autocom-box");
    const icon = searchWrapper.querySelector(".icon");
    let linkTag = searchWrapper.querySelector("a");
    let webLink;

    // if user press any key and release
    inputBox.onkeyup = (e)=>{
        let userData = e.target.value; //user enetered data
        let emptyArray = [];
        if(userData){
            icon.onclick = ()=>{
                webLink = `https://www.google.com/search?q=${userData}`;
                linkTag.setAttribute("href", webLink);
                linkTag.click();
            }
            emptyArray = suggestions.filter((data)=>{
                //filtering array value and user characters to lowercase and return only those words which are start with user enetered chars
                return data.toLocaleLowerCase().startsWith(userData.toLocaleLowerCase());
            });
            emptyArray = emptyArray.map((data)=>{
                // passing return data inside li tag
                return data = `<li>${data}</li>`;
            });
            searchWrapper.classList.add("active"); //show autocomplete box
            showSuggestions(emptyArray);
            let allList = suggBox.querySelectorAll("li");
            for (let i = 0; i < allList.length; i++) {
                //adding onclick attribute in all li tag
                allList[i].setAttribute("onclick", "select(this)");
            }
        }else{
            searchWrapper.classList.remove("active"); //hide autocomplete box
        }
    }

    function select(element){
        let selectData = element.textContent;
        inputBox.value = selectData;
        var regExp = /\(([^)]+)\)/;
                var stock_ticker = regExp.exec(inputBox.value);
                fetch('/data', {
                    headers : {
                        'Content-Type' : 'application/json'
                    },
                    method : 'POST', 
                    body : JSON.stringify( {
                        Stock : stock_ticker[1]
                    })
                })                
                .then(response => response.json())
                .then(data => {
                    
                    const formattedData = data.map(item => ({
                        time: ((new Date(item.date).getTime() / 1000) - (5 * 60 * 60)), // Convert UTC to EST (Standard Time)
                        open: item.open,
                        high: item.high,
                        low: item.low,
                        close: item.close,
                        volume: item.volume
                    }));
    
                    candleSeries.setData(formattedData);
                    //console.log((new Date(item.date).getTime() / 1000))
                })
                .catch(error => console.error('Error fetching data:', error));
        searchWrapper.classList.remove("active");
        console.log(1)
    }

    function showSuggestions(list){
        let listData;
        if(!list.length){
            userValue = inputBox.value;
            listData = `<li>${userValue}</li>`;
        }else{
        listData = list.join('');
        }
        suggBox.innerHTML = listData;
    }
    let suggestions = [
    "3M Company (MMM)",
    "Abbott Laboratories (ABT)",
    "AbbVie Inc. (ABBV)",
    "Adobe Inc. (ADBE)",
    "Advanced Micro Devices, Inc. (AMD)",
    "Alibaba Group Holding Limited (BABA)",
    "Alphabet Inc. Class A (GOOGL)",
    "Alphabet Inc. Class C (GOOG)",
    "Amazon.com, Inc. (AMZN)",
    "AMD (Advanced Micro Devices, Inc.)",
    "American Express Company (AXP)",
    "American International Group, Inc. (AIG)",
    "Amgen Inc. (AMGN)",
    "Apple Inc. (AAPL)",
    "AT&T Inc. (T)",
    "Bank of America Corporation (BAC)",
    "Berkshire Hathaway Inc. (BRK.B)",
    "BlackRock, Inc. (BLK)",
    "Boeing Co. (BA)",
    "Caterpillar Inc. (CAT)",
    "Chevron Corporation (CVX)",
    "Cisco Systems, Inc. (CSCO)",
    "Citigroup Inc. (C)",
    "Coca-Cola Company (KO)",
    "Coinbase Global, Inc. (COIN)",
    "Comcast Corporation (CMCSA)",
    "Costco Wholesale Corporation (COST)",
    "CVS Health Corporation (CVS)",
    "Delta Air Lines, Inc. (DAL)",
    "eBay Inc. (EBAY)",
    "Eli Lilly and Company (LLY)",
    "Exxon Mobil Corporation (XOM)",
    "Facebook, Inc. (FB)",
    "FedEx Corporation (FDX)",
    "Ford Motor Co. (F)",
    "General Electric Company (GE)",
    "General Motors Company (GM)",
    "Gilead Sciences, Inc. (GILD)",
    "Goldman Sachs Group, Inc. (GS)",
    "Home Depot, Inc. (HD)",
    "International Business Machines Corporation (IBM)",
    "Intel Corporation (INTC)",
    "Intuit Inc. (INTU)",
    "Johnson & Johnson (JNJ)",
    "JPMorgan Chase & Co. (JPM)",
    "Lockheed Martin Corporation (LMT)",
    "Lowe's Companies, Inc. (LOW)",
    "Mastercard Incorporated (MA)",
    "McDonald's Corporation (MCD)",
    "Merck & Co., Inc. (MRK)",
    "Meta Platforms Inc. (META)",
    "Microsoft Corporation (MSFT)",
    "Morgan Stanley (MS)",
    "Netflix, Inc. (NFLX)",
    "Nike, Inc. (NKE)",
    "NIO Inc. (NIO)",
    "NVIDIA Corporation (NVDA)",
    "Oracle Corporation (ORCL)",
    "PayPal Holdings, Inc. (PYPL)",
    "Pfizer Inc. (PFE)",
    "Procter & Gamble Company (PG)",
    "Qualcomm Incorporated (QCOM)",
    "Raytheon Technologies Corporation (RTX)",
    "Salesforce.com Inc. (CRM)",
    "Snap Inc. (SNAP)",
    "Sony Group Corporation (SONY)",
    "Square, Inc. (SQ)",
    "Starbucks Corporation (SBUX)",
    "T-Mobile US, Inc. (TMUS)",
    "Target Corporation (TGT)",
    "Tencent Holdings Limited (TCEHY)",
    "Tesla, Inc. (TSLA)",
    "The Boeing Company (BA)",
    "The Coca-Cola Company (KO)",
    "The Home Depot, Inc. (HD)",
    "The Procter & Gamble Company (PG)",
    "The Walt Disney Company (DIS)",
    "Uber Technologies, Inc. (UBER)",
    "Union Pacific Corporation (UNP)",
    "United Parcel Service, Inc. (UPS)",
    "United Technologies Corporation (UTX)",
    "UnitedHealth Group Incorporated (UNH)",
    "Verizon Communications Inc. (VZ)",
    "Visa Inc. (V)",
    "Walgreens Boots Alliance, Inc. (WBA)",
    "Walmart Inc. (WMT)",
    "Walt Disney Co. (DIS)",
    "Walt Disney Company (DIS)",
    "Wells Fargo & Company (WFC)",
    "Zoom Video Communications, Inc. (ZM)"
];
    </script>
{% endblock %}
